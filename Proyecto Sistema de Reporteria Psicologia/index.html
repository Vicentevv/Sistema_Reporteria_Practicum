<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reporte Psicología</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script type="module">
    import { obtenerPracticas } from './psico-fetch.js';
    import { generarTabla, generarXLSX } from './psico-render-xlsx.js';

    const selector = document.getElementById("selector-practica");
    const btnDescargar = document.getElementById("descargar-btn");
    const btnTodos = document.getElementById("descargar-todos-btn");
    const contenedorTabla = document.getElementById("contenedor-tabla");
    const totalTexto = document.getElementById("total-practicas");

    let practices = {};

    async function main() {
      practices = await obtenerPracticas();

      if (!practices || Object.keys(practices).length === 0) {
        totalTexto.textContent = "No se encontraron prácticas.";
        return;
      }

      totalTexto.textContent = `Total de prácticas encontradas: ${Object.keys(practices).length}`;
      selector.innerHTML = '<option value="">-- Selecciona una práctica --</option>' +
        Object.keys(practices).map(p => `<option value="${p}">Práctica: ${p}</option>`).join('');
      btnTodos.disabled = false;
    }

    selector.addEventListener("change", () => {
      const clave = selector.value;
      if (clave) {
        generarTabla(clave, practices[clave], contenedorTabla);
        btnDescargar.disabled = false;
        btnDescargar.onclick = () => generarXLSX(clave, practices[clave]);
      } else {
        contenedorTabla.innerHTML = "";
        btnDescargar.disabled = true;
      }
    });

    btnTodos.addEventListener("click", async () => {
      for (const clave of Object.keys(practices)) {
        await new Promise(resolve => {
          setTimeout(() => {
            generarXLSX(clave, practices[clave]);
            resolve();
          }, 300);
        });
      }
    });

    main();
  </script>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    select, button { margin: 0.5rem 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    th { background-color: #f0f0f0; }
  </style>
</head>
<body>
  <h2>Seleccionar práctica</h2>
  <select id="selector-practica">
    <option value="">-- Selecciona una práctica --</option>
  </select>
  <button id="descargar-btn" disabled>Descargar XLSX</button>
  <button id="descargar-todos-btn" disabled>Descargar todas las prácticas (.xlsx)</button>

  <div id="contenedor-tabla"></div>
  <p id="total-practicas"></p>
</body>
</html>
